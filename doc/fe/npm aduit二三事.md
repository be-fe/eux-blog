---
title: "npm aduit äºŒä¸‰äº‹"
author: "é™ˆè”“é’"
datetime: 2017-07-02 23:09:00
cover: ""
---

# npm aduit äºŒä¸‰äº‹
#note/blog

## å‰è¨€ï¼šä»ä¸€ä¸ª bug è¯´èµ·
æœ€è¿‘ç¢°åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œä½¿ç”¨ä¸€ä¸ªæ¡†æ¶çš„æ—¶å€™ä½¿ç”¨å…¬å¸å†…éƒ¨çš„é•œåƒè£…æ€ä¹ˆéƒ½è·‘ä¸èµ·æ¥, ç„¶è€Œåªè¦æ”¹æˆå®˜æ–¹çš„é•œåƒå°±æ²¡é—®é¢˜ï¼Œäºæ˜¯å»å¯¹æ¯”äº†ä¸‹ package.lock æ–‡ä»¶ï¼Œå¦‚å›¾ï¼š

![](https://eux-public.bj.bcebos.com/2018/07/02/df233513dd3e36bafdd4a15a69415bdc.jpg)

å¾ˆæ˜æ˜¾å¯ä»¥çœ‹å‡ºç”¨æˆ‘å‚çš„é•œåƒè£…å‡ºæ¥çš„ `nanomatch` æ˜¯ `1.2.11` çš„ç‰ˆæœ¬ï¼Œè€Œå®˜æ–¹è£…çš„ `1.2.9`ï¼Œå¿ƒé‡Œä¸€æ„£æˆ‘å»è¿˜èƒ½è¶…å‰ï¼Œè€æ—©å¬è¯´ `npm@6` çš„ä¸€ä¸»è¦ç‰¹å¾æ˜¯å®‰å…¨æœºåˆ¶ï¼Œè„‘æ´äº†ä¸€ä¸‹éš¾é“å®˜æ–¹ `npm` æºèƒ½åˆ¤æ–­æ˜¯ä¸æ˜¯æœ‰é—®é¢˜çš„åŒ…è¿˜èƒ½è‡ªåŠ¨å›æ»šåˆ°ç¨³å®šç‰ˆæœ¬ï¼Ÿ

ç ”ç©¶äº†ä¸€ç•ªï¼Œæ­£æ–‡å¼€å§‹ï¼š

## npm audit å‘½ä»¤

é¦–å…ˆçœ‹[å®˜æ–¹æ–‡æ¡£](https://medium.com/npm-inc/announcing-npm-6-5d0b1799a905)ï¼Œ`npm@6` çš„ä¸€å¤§æ›´æ–°æ˜¯æ–°å¢äº† `npm audit` å‘½ä»¤

> **Note: The npm audit command is available in npm@6. To upgrade, run npm install npm@latest -g.**
> 
> The `npm audit` command submits a description of the dependencies configured in your package to your default registry and asks for a report of known vulnerabilities. npm audit checks direct dependencies, devDependencies, bundledDependencies, and optionalDependencies, but does not check peerDependencies.

è¯¥å‘½ä»¤ä¼šåœ¨é¡¹ç›®ä¸­æ›´æ–°æˆ–è€…ä¸‹è½½æ–°çš„ä¾èµ–åŒ…ä¹‹åä¼šè‡ªåŠ¨è¿è¡Œï¼Œå¦‚æœä½ åœ¨é¡¹ç›®ä¸­ä½¿ç”¨äº†å…·æœ‰å·²çŸ¥å®‰å…¨é—®é¢˜çš„ä¾èµ–ï¼Œå°±æ”¶åˆ°å®˜æ–¹çš„è­¦å‘Šé€šçŸ¥ã€‚

ä¸ºäº†å¤ç°ï¼Œéšä¾¿æ‰¾äº†ä¸€ä¸ªæ²¡é‚£ä¹ˆå®˜æ–¹çš„é¡¹ç›® [adminMongo](https://github.com/mrvautin/adminMongo) å¹¶æ‰§è¡Œ `npm install` è¯•è¯•ï¼Œæœç„¶

```
found 5 vulnerabilities (2 low, 1 moderate, 1 high, 1 critical)
  run `npm audit fix` to fix them, or `npm audit` for details
```

å†æ‰§è¡Œä¸‹ `npm aduit` æŸ¥çœ‹è¯¦æƒ…ï¼Œåˆ—è¡¨å¾ˆæ¸…æ™°ã€‚

![](https://eux-public.bj.bcebos.com/2018/07/02/df233513dd3e36bafdd4a15a69415bdc.jpg)

æ‰§è¡Œ `npm audit fix`ï¼Œå‘ç°å¹¶æ²¡æœ‰èƒ½è‡ªåŠ¨çš„å¸®æˆ‘ fix æ‰è¿™äº›é”™è¯¯ã€‚

```bash
fixed 0 of 5 vulnerabilities in 1295 scanned packages
  2 package updates for 5 vulns involved breaking changes
  (use `npm audit fix --force` to install breaking changes; or do it by hand)
```

æ ¹æ®æç¤ºå°è¯•æ‰§è¡Œ `npm audit fix --force`ï¼Œå‘ç°ä»–å¸®æˆ‘æŠŠåŒ…è‡ªåŠ¨æ›´æ–°åˆ°äº†æ¨èç‰ˆæœ¬ï¼ˆ`supertest@3.1.0`ï¼Œ`mocha@5.2.0`ï¼‰ã€‚

ps. ç›´æ¥è¿è¡Œ `--force` çš„è¡Œä¸ºä¸è¦å­¦ä¹ ï¼Œå¯¹äºæ²¡èƒ½è‡ªåŠ¨ä¿®å¤çš„é—®é¢˜ï¼Œè¯´æ˜è‚¯å®šå‡ºç°äº† `SEMVER WARNING` ä¹‹ç±»çš„è­¦å‘Šï¼Œè¿™æ„å‘³ç€æ¨èçš„ä¿®å¤ç‰ˆæœ¬å­˜åœ¨è®©ä»£ç å‡ºé—®é¢˜çš„å¯èƒ½ï¼Œä¸»è¦å‘ç”Ÿåœ¨ä¾èµ–åŒ…æ›´æ”¹äº† API æˆ–è€…å‡çº§äº†å¤§ç‰ˆæœ¬çš„æƒ…å†µä¸‹ï¼ˆsemantic version major changeï¼Œæ¯”å¦‚æˆ‘è¿™ä¸ªé¡¹ç›®çš„ `supertest` ç‰ˆæœ¬æ˜¯ 1.2.0ï¼Œè€Œæ¨èçš„æ˜¯ 3.1.0ï¼‰ã€‚è¿™æ—¶å€™å°±éœ€è¦æ ¼å¤–çš„å°å¿ƒç”šè‡³éœ€è¦æ”¹åŠ¨ä¸€äº›è‡ªå·±çš„ä»£ç äº†ã€‚

å¦å¤–è¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œå°±æ˜¯å®˜æ–¹å‘ç°äº†æ¼æ´ï¼Œä½†æ˜¯ç›®å‰æ²¡æœ‰å¯ç”¨çš„è¡¥ä¸ã€‚è¿™æ—¶å€™å°±æ˜¯ä¸ªä½“åŠ›åŠ³åŠ¨äº† :)

çœ‹çœ‹è¿™å‘½ä»¤åˆ°åº•å¸®æˆ‘ä»¬å¹²äº†å•¥ï¼Œç®€å•ç¿»è¯‘äº†ä¸€ä¸‹ [å®˜æ–¹æ–‡æ¡£](https://docs.npmjs.com/cli/audit)

```bash
# æ‰«æé¡¹ç›®æ¼æ´æŠŠä¸å®‰å…¨çš„ä¾èµ–é¡¹è‡ªåŠ¨æ›´æ–°åˆ°å…¼å®¹æ€§ç‰ˆæœ¬
npm audit fix

# åœ¨ä¸ä¿®æ”¹ node_modules çš„æƒ…å†µä¸‹æ‰§è¡Œ audit fixï¼Œä»ç„¶ä¼šæ›´æ”¹ pkglock
npm audit fix --package-lock-only

# è·³è¿‡æ›´æ–° devDependencies
npm audit fix --only=prod

# å¼ºåˆ¶æ‰§è¡Œ audit fix å®‰è£…æœ€æ–°çš„ä¾èµ–é¡¹ï¼ˆtoplevelï¼‰
npm audit fix --force

# å•çº¯çš„è·å– audit fix ä¼šåšçš„äº‹ï¼Œå¹¶ä»¥ json æ ¼å¼è¾“å‡ºã€‚
npm audit fix --dry-run --json

# è·å–è¯¦æƒ…
npm audit

# ä»¥ JSON æ ¼å¼æ‰“å°æŠ¥å‘Š
npm audit --json
```

è‡³äºå¦‚ä½•å…³é—­å®‰å…¨æ£€æŸ¥ï¼Œå¯ä»¥é‡‡ç”¨ä»¥ä¸‹æ–¹å¼ï¼š
- å®‰è£…å•ä¸ªåŒ…å…³é—­å®‰å…¨å®¡æŸ¥: `npm install example-package-name --no-audit`
- å®‰è£…æ‰€æœ‰åŒ…å…³é—­å®‰å…¨å®¡æŸ¥
	- è¿è¡Œ `npm set audit false`
	- æ‰‹åŠ¨å°† `~/.npmrc` é…ç½®æ–‡ä»¶ä¸­çš„ `audit` ä¿®æ”¹ä¸º `false`

## aduit æŠ¥å‘Š

é€šè¿‡æŸ¥çœ‹æ–‡æ¡£å’Œæºç å‘ç°ï¼Œ`npm aduit` ä¸»è¦åŠ¨ä½œå°±æ˜¯åœ¨ `npm install` å®Œæˆä¹‹åæŠŠéœ€è¦æ£€æŸ¥çš„åŒ…çš„ä¿¡æ¯å‘é€ç»™ä¸€ä¸ªå®˜æ–¹æ¥å£, å†æ ¹æ®è¿”å›ä¿¡æ¯ç”Ÿæˆä¸€ä¸ªåŒ…å«åŒ…åç§°ã€æ¼æ´ä¸¥é‡æ€§ã€ç®€ä»‹, è·¯å¾„ç­‰çš„æŠ¥å‘Šã€‚å¤„ç†æ ¼å¼åŒ–ä»€ä¹ˆçš„ä¸»è¦åœ¨äº [npm-audit-report](https://www.npmjs.com/package/npm-audit-report) æ¨¡å—ï¼Œæœ‰å…´è¶£çš„ä¹Ÿå¯ä»¥ç ”ç©¶ä¸‹ã€‚

é‚£ä¹ˆæŠ¥å‘Šæ˜¯æ ¹æ®ä»€ä¹ˆç”Ÿæˆçš„å‘¢ï¼Œæ ¹æ® aduit çš„æç¤ºä¿¡æ¯æˆ‘ä»¬èƒ½å‘ç°ä¸€ä¸ª [node å®‰å…¨å¹³å°](https://nodesecurity.io/)ï¼Œè¿›å»é¦–é¡µå°±çœ‹åˆ°ä¸€å¥ç±»ä¼¼ã€å¥½æ¶ˆæ¯ï¼Œ2018 å¹´ 4 æœˆ 10 å·ï¼Œnpm æ­£å¼å…¥é©»æˆ‘ä»¬å¹³å°ã€çš„é€šçŸ¥ã€‚æ‰€ä»¥çœ‹æ¥ aduit çš„æ•°æ®æ¥æºä¹Ÿæ‰¾åˆ°äº†ã€‚


## æ€»ç»“
æ€»çš„æ¥è¯´ï¼Œå®‰å…¨é—®é¢˜æ˜¯ä¸å®¹å¿½è§†ã€‚ä»¥ç›®å‰çŠ¶å†µæ˜¯å¤§å®¶æ‹¿åˆ°é¡¹ç›®ä¹‹åç›´æ¥ `npm install`ï¼Œåªè¦é¡¹ç›®èƒ½æˆåŠŸè¿è¡ŒåŸºæœ¬æ²¡æœ‰äººä¼šå»å…³æ³¨è£…äº†ä»€ä¹ˆã€‚ä¸€å¤§å †é”™ç»¼å¤æ‚çš„ç›¸äº’å…³è”çš„ä¾èµ–åŒ…ï¼Œå°±ç®—å¼€å‘è€…æœ‰å®‰å…¨æ„è¯†ï¼Œä¹Ÿç¼ºä¹è§£å†³å®‰å…¨æ¼æ´çš„æ‰‹æ®µã€‚æ‰€ä»¥è¿™æ¬¡ npm å®˜æ–¹çš„åšæ³•è¿˜æ˜¯å¾ˆå€¼å¾—ç§°èµçš„ã€‚

## æœ€åçš„æœ€å
æƒ³åˆ°ç›®å‰å·²ç»æœ‰å¾ˆå¤§ä¸€éƒ¨åˆ†åŒå­¦è½¬ç§»å»äº† `yarn` é˜µè¥ï¼Œç”šè‡³æœ‰ä¸€äº›å¹¶ä¸çŸ¥é“ä¸ºä»€ä¹ˆå°±è½¬è¿‡å»äº†åªæ˜¯å½“æ—¶å¾ˆå¤šäººæ¨èä½¿ç”¨å®ƒã€‚å…¶å®ä¸»è¦æ˜¯åœ¨ npm v4 æ—¶æœŸå®‰è£è¶…æ…¢ï¼Œæ‰ä¼šè®© yarn å´›èµ·ï¼Œåœ¨ v5 çš„æ—¶å€™å…¶å®æ”¹å–„ä¸å°‘äº†ï¼Œv6 åº”è¯¥æ˜¯å†æ¬¡å¼ºè°ƒæƒ³å¤ºå›è¿™ä¹ˆä¸€éƒ¨åˆ†ç”¨æˆ· ğŸ˜ï¼Ÿæœ‰å…´è¶£çš„å¯ä»¥å†è‡ªè¡Œç ”ç©¶ä¸‹ yarn å’Œ npm çš„å¯¹æ¯”ï¼Œ è¿™é‡Œæœ‰ä¸€ä¸ª [npm5.7.1 vs yarn1.5.1 æ•°æ®ä¸Šçš„æ¯”è¾ƒä»¥åŠæ¯”è¾ƒæ–¹æ³•](https//github.com/appleboy/npm-vs-yarn)ã€‚

å†æœ‰å…¶å® npm ç°åœ¨ä¹Ÿæœ‰å¾ˆå¤šåŠŸèƒ½ä¼¼ä¹ç”¨çš„äººä¸æ˜¯å¾ˆå¤šï¼Œç¯‡å¹…æœ‰é™ç®€å•æå‡ ä¸ªè‡ªè®¤ä¸ºè¿˜ä¸é”™çš„ã€‚
1.  `npx` 
2. æ›´æ”¹npm å®‰è£…åŒ…çš„ç›®å½•`npm config set prefix <new_path>`ï¼ˆåœ¨æ²¡æœ‰ sudo æƒé™çš„åœºæ™¯å¾ˆæœ‰ç”¨ï¼‰
3. åœ¨å¼€å‘ npm æ¨¡å—çš„æ—¶å€™ä½¿ç”¨ `npm link` ç­‰â€¦

è‡³äºå‰é¢è¯´çš„é—®é¢˜è§£å†³æ–¹æ¡ˆï¼Œå’¨è¯¢äº†å®˜æ–¹åŒå­¦ä»¥åŠç¿»äº†ä¸‹ nanomatch çš„ [issue](https://github.com/micromatch/nanomatch/issues/15)ï¼Œå‘ç°æ˜¯åŒ…çš„é—®é¢˜ã€‚å†è€…å°±æ˜¯å†…éƒ¨é•œåƒæ²¡æœ‰åŠæ—¶åŒæ­¥ï¼Œæœç„¶å½“æ™šå›åˆ°å®¶ä¹‹åå†çœ‹äº†ä¸€çœ¼ä¸€åˆ‡åˆæ¢å¤æ­£å¸¸ï¼Œå°±å½“ä¸€ä¸ªå­¦ä¹ çŸ¥è¯†çš„ç»å†ã€‚

## å‚è€ƒèµ„æ–™
- https://docs.npmjs.com/cli/audit
- https://docs.npmjs.com/getting-started/running-a-security-audit